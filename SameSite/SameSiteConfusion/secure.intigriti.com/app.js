const express = require('express');
const jwt = require('jsonwebtoken');
const cookieParser = require('cookie-parser');

const key = 'MyS3cur3K3y';
const users = {
    'admin': {
        pass: 'admin',
        change: Date.now() / 1000
    }
};

const app = express();
app.use(express.json());
app.use(cookieParser());

function auth(req, res, next) {
    const user = jwt.verify(req.cookies.jwt, key);
    if (user.iat > users[user.user].change) req.user = user;
    else return res.status(401).send('Token expired');
    return next();
}

app.post('/login', (req, res) => {
    const { name, pass } = req.body;
    if (!(name && pass)) return res.status(400).send('All input is required');
    const user = users[name];
    if (user.pass === pass) {
        user.token = jwt.sign({user: name}, key);
        res.cookie('jwt', user.token, {sameSite: 'strict'});
        return res.status(200).json(user);
    }
    return res.status(400).send('Invalid Credentials');
});

app.get('/login/:name/:pass', (req, res) => {
    const name = req.params.name;
    const pass = req.params.pass;

    if (!(name && pass)) return res.status(400).send('All input is required');
    const user = users[name];
    if (user.pass === pass) {
        user.token = jwt.sign({user: name}, key);
        res.cookie('jwt', user.token, {sameSite: 'strict'});
        return res.status(200).json(user);
    }
    return res.status(400).send('Invalid Credentials');
});


app.post('/change_pass', auth, (req, res) => {
    const user = users[req.user.user];
    user.pass = req.body.pass;
    user.change = Date.now() / 1000;
    res.status(200).send('Password changed!');
})


app.get('/', auth, (req, res) => {
    res.send('Hello World!')
})

app.listen(3000);
